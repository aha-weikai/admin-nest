import { ConfigService } from '@/common/config.service';
import { RedisService } from '@/common/redis.service';
import { Injectable } from '@nestjs/common';
import { now } from 'lodash';
import md5 from 'md5';
import * as svgCaptcha from 'svg-captcha-fixed';

@Injectable()
export class CaptchaService {
  constructor(
    private redis: RedisService,
    private config: ConfigService,
  ) {}
  async create() {
    let data;
    if (this.config.get('isDev') === 'true') {
      data = devSvgCaptchaData;
    } else {
      data = svgCaptcha.createMathExpr({
        mathMax: 9,
        mathMin: 0,
        mathOperator: '+-',
        size: 6,
        noise: 3,
        color: true,
        height: 32,
      });
    }

    const captchaKey = md5('' + now());
    await this.redis.set(`captcha:${captchaKey}`, data.text);

    return {
      captchaKey,
      data: data.data,
    };
  }

  async verify(captchaKey, answer) {
    const correctAnswer = await this.redis.get(`captcha:${captchaKey}`);
    if (correctAnswer === answer) {
      return true;
    } else {
      return false;
    }
  }
}

const devSvgCaptchaData = {
  text: '12',
  data: '<svg xmlns="http://www.w3.org/2000/svg" width="150" height="32" viewBox="0,0,150,32"><path d="M12 14 C67 19,92 7,138 17" stroke="#c1e065" fill="none"/><path d="M6 10 C96 9,64 18,147 6" stroke="#b859d8" fill="none"/><path d="M15 7 C60 6,87 30,137 3" stroke="#dddd40" fill="none"/><path fill="#70dbc0" d="M72.58 30.51L72.49 30.43L72.52 30.45L72.52 30.46Q72.22 30.50 71.89 30.54L71.89 30.54Q71.60 30.56 71.28 30.58L71.28 30.58L71.07 30.38L71.18 30.48L69.74 30.53L69.76 30.55L70.16 23.64L70.18 23.66L70.26 23.74L67.44 23.70L67.49 23.75L67.53 23.79Q67.14 23.75 66.58 23.72L66.58 23.72Q65.83 23.67 64.78 23.63L64.78 23.63L64.78 23.62L64.79 23.64L64.65 20.90L64.72 20.97L64.66 20.92L70.07 21.34L70.10 21.37L70.15 21.42L69.51 14.46L69.54 14.49L69.43 14.38Q69.95 14.52 70.43 14.59L70.43 14.59Q70.82 14.64 71.18 14.64L71.18 14.64L71.13 14.59L72.78 14.61L72.67 14.50L72.42 21.33L72.55 21.46L72.53 21.44L77.94 21.14L77.94 21.14Q77.87 21.90 77.84 22.64L77.84 22.64Q77.82 23.17 77.82 23.68L77.82 23.68L77.73 23.60L77.82 23.68L77.74 23.60Q77.61 23.61 77.36 23.62L77.36 23.62Q77.09 23.64 76.69 23.66L76.69 23.66L76.78 23.75L76.78 23.74L74.99 23.59L75.08 23.69L75.01 23.61L72.35 23.62L72.43 27.12L72.44 27.14L72.40 27.10ZM78.32 20.61L78.23 20.52L78.33 20.61L78.36 20.65L74.48 20.91L74.43 20.86Q74.56 19.53 74.72 18.43L74.72 18.43Q74.92 16.98 75.16 15.92L75.16 15.92L75.16 15.92L75.26 16.03L75.26 16.03Q74.97 16.08 74.52 16.14L74.52 16.14Q73.98 16.21 73.21 16.29L73.21 16.29L73.10 16.19L73.16 15.12L73.22 14.06L73.23 14.07L73.17 14.01Q71.88 14.05 70.82 14.04L70.82 14.04Q69.78 14.04 68.95 13.98L68.95 13.98L69.01 14.04L69.02 14.04L68.86 13.89Q69.30 15.62 69.56 17.46L69.56 17.46Q69.82 19.27 69.92 21.19L69.92 21.19L69.72 20.99L69.73 21.00Q68.94 20.99 67.74 20.86L67.74 20.86Q66.31 20.71 64.31 20.38L64.31 20.38L64.20 20.26L64.32 20.39L64.54 24.15L65.23 24.08L66.00 24.08L65.99 24.07Q66.04 24.50 66.01 25.10L66.01 25.10Q65.99 25.63 65.92 26.29L65.92 26.29L65.86 26.23L67.88 26.13L69.84 25.99L69.96 26.10L69.90 26.04Q69.80 27.35 69.69 28.43L69.69 28.43Q69.53 29.95 69.35 31.01L69.35 31.01L69.35 31.01L69.28 30.95L71.46 30.84L71.41 30.79L71.39 32.83L71.51 32.95L75.50 32.94L75.64 33.08L74.42 25.95L74.44 25.97L74.51 26.04L79.86 26.45L79.76 26.35L79.64 24.52L79.61 23.53L79.64 22.61L79.53 22.50L79.58 22.55L78.91 22.68L78.09 22.66L78.07 22.64L78.16 22.73"/><path fill="#7fe0af" d="M108.02 20.12L108.00 20.10L108.07 20.17L108.03 20.13L105.09 21.61L105.12 21.64L105.04 21.55Q104.49 22.06 104.14 22.68L104.14 22.68Q103.65 23.56 103.56 24.68L103.56 24.68L103.69 24.81L103.57 24.69Q103.57 25.87 103.88 26.71L103.88 26.71Q104.19 27.53 104.79 28.02L104.79 28.02L104.76 27.99L104.69 27.93L104.59 27.82Q105.25 28.38 106.10 28.64L106.10 28.64Q106.97 28.90 108.04 28.86L108.04 28.86L107.99 28.81L108.04 28.86Q109.25 28.86 110.10 28.63L110.10 28.63Q110.98 28.39 111.46 27.90L111.46 27.90L111.26 27.70L111.19 27.63L111.31 27.75Q111.73 27.15 111.95 26.50L111.95 26.50Q112.28 25.55 112.21 24.47L112.21 24.47L112.30 24.55L112.27 24.52L112.21 24.47L111.10 21.48L110.99 21.38L111.02 21.40ZM108.14 10.84L107.99 10.69L108.08 10.78L108.02 10.72L105.25 11.07L105.40 11.21L104.24 13.79L104.24 13.79L104.31 13.86L108.16 17.60L108.04 17.47L110.69 16.62L110.69 16.62L110.73 16.66Q111.14 16.14 111.38 15.55L111.38 15.55Q111.69 14.79 111.71 13.91L111.71 13.91L111.72 13.92L111.59 13.79Q111.68 12.91 111.51 12.32L111.51 12.32Q111.37 11.80 111.03 11.51L111.03 11.51L111.00 11.49L110.99 11.48ZM107.78 31.30L107.83 31.35L104.77 31.33L104.80 31.36Q103.84 31.30 102.98 30.97L102.98 30.97Q102.39 30.74 101.84 30.39L101.84 30.39L101.79 30.34L101.83 30.37L100.65 26.42L100.68 26.45L100.58 26.34L104.80 18.66L104.79 18.64L104.83 18.69L101.15 12.34L101.17 12.36Q101.03 11.60 101.00 11.01L101.00 11.01Q100.98 10.59 101.01 10.26L101.01 10.26L100.80 10.04L100.81 10.06Q100.99 8.77 102.38 8.24L102.38 8.24Q103.31 7.89 104.80 7.87L104.80 7.87L104.90 7.98L104.93 8.01L110.45 7.97L110.55 8.07L110.47 7.99L114.83 10.60L114.95 10.71L114.92 10.68Q114.97 10.98 115.00 11.22L115.00 11.22Q115.03 11.48 115.03 11.67L115.03 11.67L114.96 11.60L114.94 11.58L114.73 12.86L114.77 12.90L111.18 18.60L111.27 18.69L111.22 18.64Q112.90 18.96 113.86 20.45L113.86 20.45Q114.82 21.93 115.06 24.57L115.06 24.57L115.25 24.76L115.20 24.72L115.18 26.10L115.26 26.18L113.72 29.97L113.76 30.01L113.76 30.01Q113.06 30.56 111.35 30.94L111.35 30.94Q109.97 31.25 107.93 31.45L107.93 31.45ZM110.01 33.57L110.10 33.66L113.39 33.67L113.49 33.78L113.45 33.74Q114.48 33.79 115.44 33.56L115.44 33.56Q116.09 33.40 116.71 33.11L116.71 33.11L116.66 33.06L116.65 33.05Q117.11 32.74 117.40 32.23L117.40 32.23Q117.79 31.52 117.84 30.43L117.84 30.43L117.95 30.54L117.84 30.43Q117.89 29.95 117.83 29.25L117.83 29.25Q117.77 28.49 117.57 27.46L117.57 27.46L117.43 27.33L117.43 27.32L117.55 27.44Q117.08 24.89 116.22 23.19L116.22 23.19Q115.54 21.83 114.61 21.00L114.61 21.00L114.56 20.95L114.29 20.49L114.16 20.28L114.05 20.06L114.05 20.06L113.94 19.95Q114.83 19.21 115.50 17.64L115.50 17.64Q116.07 16.32 116.49 14.43L116.49 14.43L116.59 14.53L116.46 14.39L116.48 14.42Q116.47 14.21 116.49 13.89L116.49 13.89Q116.50 13.59 116.54 13.18L116.54 13.18L116.63 13.27L116.59 13.23L116.60 13.24L116.60 11.95L116.55 11.90L116.55 11.90Q116.55 11.28 116.28 10.84L116.28 10.84Q115.98 10.37 115.37 10.11L115.37 10.11L115.19 9.93L115.38 10.08L115.21 9.95L115.03 9.81L115.12 9.90L115.17 9.95Q115.03 9.55 114.60 9.13L114.60 9.13Q114.26 8.79 113.74 8.44L113.74 8.44L113.59 8.29L113.64 8.32L113.75 8.41L113.77 8.44L107.58 7.42L107.73 7.57L104.74 7.52L104.81 7.58Q104.34 7.58 103.73 7.62L103.73 7.62Q103.24 7.66 102.67 7.72L102.67 7.72L102.55 7.61L102.64 7.70L102.62 7.68L100.43 9.68L100.49 9.73L100.47 11.00L100.52 11.06L100.54 11.08Q100.56 11.30 100.71 11.97L100.71 11.97Q100.87 12.69 101.16 13.91L101.16 13.91L101.10 13.84L101.12 13.87L101.14 13.89Q101.62 15.80 102.42 17.05L102.42 17.05Q102.98 17.91 103.70 18.46L103.70 18.46L103.67 18.43L103.72 18.49L103.69 18.45L100.47 25.02L100.39 24.94L100.40 24.95Q100.37 26.13 100.35 26.95L100.35 26.95Q100.34 27.75 100.34 28.20L100.34 28.20L100.29 28.15L100.36 28.22L100.29 28.15Q100.34 28.97 100.61 29.61L100.61 29.61Q100.93 30.38 101.58 30.89L101.58 30.89L101.54 30.84L101.65 30.96L101.61 30.92L101.86 31.05L101.97 31.17L101.93 31.13ZM109.67 22.49L109.72 22.54L109.76 22.58L111.51 22.93L111.53 22.95L111.47 22.89Q111.66 23.34 111.75 23.70L111.75 23.70Q111.86 24.14 111.84 24.44L111.84 24.44L111.86 24.45L111.92 24.51L111.84 25.00L111.96 25.13L111.98 25.15Q112.01 26.26 111.55 27.03L111.55 27.03Q111.01 27.96 109.76 28.41L109.76 28.41L109.57 28.22L109.64 28.29L109.70 28.35L108.03 28.47L108.01 28.44L105.86 28.21L105.78 28.12Q105.69 27.81 105.68 27.35L105.68 27.35Q105.67 27.01 105.70 26.60L105.70 26.60L105.51 26.41L105.54 26.44L105.65 26.55L106.98 23.70L107.00 23.73ZM109.88 12.99L109.97 13.08L109.90 13.01L109.94 13.06Q110.34 13.02 110.66 13.03L110.66 13.03Q111.03 13.05 111.31 13.13L111.31 13.13L111.26 13.08L111.31 13.53L111.20 13.82L111.18 13.80L111.28 13.90L110.27 16.23L110.44 16.40Q109.84 16.86 109.14 17.00L109.14 17.00Q108.59 17.12 107.98 17.03L107.98 17.03L108.02 17.07L108.06 17.11L106.73 16.97L106.72 16.96L106.75 16.98L106.49 15.93L106.51 15.94L106.53 15.96Q106.34 15.19 106.58 14.59L106.58 14.59Q106.80 14.03 107.39 13.63L107.39 13.63L107.44 13.68L107.38 13.62L107.44 13.68"/><path fill="#41dc41" d="M30.22 24.01L30.17 23.96L30.23 24.02L30.20 23.99L36.43 23.67L36.36 23.60L36.37 18.70L36.36 18.69L36.69 13.81L36.55 13.67L36.52 13.64Q36.10 14.39 35.00 16.22L35.00 16.22Q33.37 18.94 30.25 24.04L30.25 24.04ZM40.16 31.39L40.01 31.25L40.13 31.36Q39.35 31.26 38.52 31.19L38.52 31.19Q37.66 31.11 36.75 31.08L36.75 31.08L36.61 30.93L36.59 30.91L36.61 30.94Q36.58 29.85 36.54 28.71L36.54 28.71Q36.49 27.50 36.44 26.23L36.44 26.23L36.29 26.09L36.30 26.10L36.25 26.05L26.21 27.27L26.23 27.29Q26.32 27.05 26.43 26.64L26.43 26.64Q26.51 26.31 26.59 25.86L26.59 25.86L26.50 25.77L26.45 25.72L26.52 25.79Q27.45 23.92 29.00 21.10L29.00 21.10Q30.19 18.94 31.75 16.21L31.75 16.21L31.98 16.44L31.88 16.34L38.28 7.67L38.30 7.68L40.72 7.10L40.72 7.10L40.88 7.26L38.89 20.65L38.92 20.68L39.02 23.68L39.60 23.67L40.33 23.80L40.17 23.64L41.44 23.85L41.53 23.93L41.56 23.97L41.93 26.88L41.90 26.86L39.24 26.44L39.12 26.32L39.05 26.26ZM41.73 23.49L41.73 23.49L41.74 23.50L41.76 23.52Q41.59 23.41 41.45 23.36L41.45 23.36Q41.34 23.32 41.26 23.32L41.26 23.32L41.28 23.34L41.22 23.47L41.06 23.50L40.99 23.43L41.05 23.50L40.78 20.45L40.95 20.61Q40.93 17.77 41.33 15.00L41.33 15.00Q41.82 11.52 42.97 8.17L42.97 8.17L42.85 8.05L42.88 8.08L42.88 8.08L40.61 8.67L40.64 8.69Q40.81 8.38 41.01 7.87L41.01 7.87Q41.22 7.36 41.45 6.65L41.45 6.65L41.48 6.68L41.41 6.60Q40.83 6.72 40.15 6.83L40.15 6.83Q39.17 6.99 37.96 7.12L37.96 7.12L38.02 7.18L38.00 7.16Q36.15 9.29 33.98 12.56L33.98 12.56Q31.65 16.09 28.94 20.94L28.94 20.94L28.81 20.81L30.03 19.16L31.07 17.32L31.05 17.30Q30.84 17.78 30.68 18.16L30.68 18.16Q30.49 18.58 30.35 18.89L30.35 18.89L30.39 18.92L25.80 27.82L25.75 27.77L25.84 27.85Q26.15 27.78 26.58 27.66L26.58 27.66Q27.05 27.52 27.64 27.33L27.64 27.33L27.69 27.38L27.51 27.59L27.53 27.60L27.49 27.56L27.18 29.61L27.10 29.53Q29.41 28.67 32.01 28.38L32.01 28.38Q33.88 28.16 35.90 28.24L35.90 28.24L36.04 28.38L36.08 28.43Q36.11 28.83 36.16 29.40L36.16 29.40Q36.23 30.22 36.35 31.39L36.35 31.39L36.20 31.24L36.29 31.34L36.22 31.26L38.37 31.40L38.44 31.47Q38.53 31.80 38.63 32.26L38.63 32.26Q38.75 32.81 38.90 33.56L38.90 33.56L38.73 33.40L38.77 33.43L43.79 34.69L43.81 34.70L43.76 34.66Q43.17 33.42 42.62 31.83L42.62 31.83Q42.20 30.61 41.80 29.20L41.80 29.20L41.82 29.22L42.59 29.49L43.21 29.62L43.30 29.70L43.36 29.77Q43.66 29.80 44.01 29.92L44.01 29.92Q44.27 30.02 44.55 30.16L44.55 30.16L44.60 30.20L44.62 30.22L44.70 30.30Q44.27 29.05 44.01 28.01L44.01 28.01Q43.73 26.89 43.66 26.02L43.66 26.02L43.63 26.00L43.59 25.96L43.65 26.02L42.05 25.75L41.89 25.59ZM33.69 23.30L33.77 23.37L33.72 23.32L36.06 19.50L36.15 19.59L36.08 19.51L36.03 21.40L36.01 21.38Q35.98 21.82 35.97 22.26L35.97 22.26Q35.96 22.76 35.98 23.26L35.98 23.26L35.98 23.26L35.95 23.23L36.06 23.34L34.91 23.29L34.88 23.27Q34.62 23.32 34.33 23.35L34.33 23.35Q34.07 23.38 33.77 23.38L33.77 23.38"/></svg>',
};
